# Context
Filename: LLM_Provider_Configuration_Task.md
Created On: 2025-01-09
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
实现一个功能，允许用户在界面上选择LLM provider（暂时只需要接入openRouter），提示填写APIkey（必选）、API Base URL（可选），写入配置文件，并设计对应的command。

具体要求：
1. 用户可以在界面上选择llm provider（暂时只需要接入openRouter）
2. 提示填写 APIkey（必选）、API Base URL（可选）
3. 写入配置文件（配置文件保存在 .termichat 目录下或其他兼容不同操作系统的方案）
4. 对应的command要如何设计？

# Project Overview
Gemini CLI 是一个基于Ink构建的终端界面应用程序，具有复杂的配置系统、认证系统和命令架构。当前已支持多种认证方式（Google OAuth、Gemini API Key、Vertex AI、Custom LLM），并有完善的配置文件管理系统。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 现有配置系统架构分析

### 配置文件管理
- **配置目录**: 使用 `.gemini` 目录作为配置目录名（常量：`SETTINGS_DIRECTORY_NAME`）
- **用户配置路径**: `~/.gemini/settings.json` （通过 `USER_SETTINGS_DIR` 和 `USER_SETTINGS_PATH`）
- **系统配置路径**: 跨平台支持（macOS、Windows、Linux）
- **工作区配置路径**: `<workspace>/.gemini/settings.json`
- **配置层级**: System < User < Workspace（后者覆盖前者）

### 认证系统架构
- **AuthType枚举**: 定义了5种认证类型
  - `LOGIN_WITH_GOOGLE = 'oauth-personal'`
  - `USE_GEMINI = 'gemini-api-key'`
  - `USE_VERTEX_AI = 'vertex-ai'`
  - `CLOUD_SHELL = 'cloud-shell'`
  - `USE_CUSTOM_LLM = 'custom-llm'`
- **配置验证**: `validateAuthMethod()` 函数验证各种认证方式的环境变量要求
- **配置生成**: `createContentGeneratorConfig()` 根据认证类型生成配置

### 命令系统架构
- **模块化设计**: 每个命令都有独立的模块文件（如 `authCommand.ts`）
- **加载机制**: 通过 `BuiltinCommandLoader` 和 `CommandService` 加载命令
- **命令结构**: `SlashCommand` 接口定义命令的name、description、action等
- **上下文传递**: `CommandContext` 提供服务、UI、会话等上下文

### 用户界面组件
- **AuthDialog**: 现有的认证选择对话框，使用 `RadioButtonSelect` 组件
- **对话框架构**: 通过 action 返回 `{ type: 'dialog', dialog: 'auth' }` 打开对话框
- **配置保存**: 通过 `settings.setValue(scope, key, value)` 保存配置

## 关键文件和依赖关系

### 核心配置文件
- `packages/cli/src/config/settings.ts`: 配置管理核心
- `packages/core/src/core/contentGenerator.ts`: 认证类型定义和配置生成
- `packages/cli/src/config/auth.ts`: 认证验证逻辑

### 命令系统文件
- `packages/cli/src/ui/commands/authCommand.ts`: 认证命令实现
- `packages/cli/src/services/BuiltinCommandLoader.ts`: 内置命令加载器
- `packages/cli/src/ui/commands/types.ts`: 命令类型定义

### UI组件文件
- `packages/cli/src/ui/components/AuthDialog.tsx`: 认证对话框
- `packages/cli/src/ui/hooks/useAuthCommand.ts`: 认证命令钩子

### 约束条件
1. **目录命名**: 当前使用 `.gemini` 目录，但用户要求使用 `.termichat` 目录
2. **配置兼容性**: 需要保持与现有配置系统的兼容性
3. **平台兼容性**: 需要支持 macOS、Windows、Linux
4. **扩展性**: 虽然当前只需要 openRouter，但架构应支持未来扩展其他 LLM providers

# Proposed Solution (Populated by INNOVATE mode)

## 方案选择：独立LLM Provider配置系统

经过多维度思考，推荐采用**独立的LLM Provider配置系统**，理由如下：

### 架构优势
1. **概念清晰**: LLM provider选择与认证方式分离，避免概念混淆
2. **扩展性强**: 便于未来支持多个provider同时配置和切换
3. **系统稳定**: 不影响现有认证系统，降低风险
4. **专业化**: 可以为provider配置设计专门的用户界面

### 核心设计理念

#### 1. 配置目录迁移策略
- **优先级**: `.termichat` > `.gemini` （渐进式迁移）
- **新配置**: 统一使用 `.termichat` 目录
- **兼容性**: 继续支持读取 `.gemini` 目录的配置
- **跨平台**: 保持现有的系统路径策略

#### 2. 配置数据结构
```typescript
interface LLMProviderConfig {
  name: string;           // 'openrouter'
  displayName: string;    // 'OpenRouter'
  apiKey: string;         // 必填
  baseUrl?: string;       // 可选，默认值
  isDefault?: boolean;    // 是否为默认provider
  enabled?: boolean;      // 是否启用
}

interface Settings {
  // ... 现有字段
  llmProviders?: Record<string, LLMProviderConfig>;
  defaultLLMProvider?: string;
}
```

#### 3. 命令设计
```
/provider                    # 显示当前配置的providers
/provider add <name>         # 添加新的provider配置
/provider edit <name>        # 编辑现有provider配置
/provider remove <name>      # 删除provider配置
/provider set-default <name> # 设置默认provider
/provider list               # 列出所有可用的provider类型
```

#### 4. 用户界面设计
- **ProviderDialog**: 新的provider配置对话框
- **ProviderListDialog**: provider选择和管理对话框
- **InputField组件**: 支持API Key输入（带遮罩）和URL输入
- **复用**: 使用现有的RadioButtonSelect等组件

#### 5. 与现有系统集成
- **AuthType扩展**: 添加 `USE_LLM_PROVIDER` 认证类型
- **配置验证**: 在 `validateAuthMethod` 中验证provider配置
- **内容生成**: 在 `createContentGeneratorConfig` 中处理provider配置

### 技术实现路径

#### Phase 1: 基础架构
1. 扩展Settings接口，添加LLM provider配置字段
2. 修改配置目录策略，支持 `.termichat` 目录
3. 创建LLMProviderConfig接口和相关类型定义

#### Phase 2: 命令系统
1. 创建 `providerCommand.ts` 模块
2. 实现各个子命令的逻辑
3. 集成到BuiltinCommandLoader中

#### Phase 3: 用户界面
1. 创建ProviderDialog组件
2. 创建provider输入字段组件
3. 实现provider管理的用户交互流程

#### Phase 4: 系统集成
1. 扩展AuthType枚举
2. 修改认证验证逻辑
3. 集成到内容生成系统中

### 兼容性和迁移策略
- **向后兼容**: 继续支持现有的 `.gemini` 配置
- **自动迁移**: 首次使用时提示用户是否迁移配置
- **优雅降级**: 如果provider配置有问题，自动回退到现有的认证方式

# Implementation Plan (Generated by PLAN mode)

## 详细实现计划

### Phase 1: 配置系统基础架构

#### 1.1 创建LLM Provider类型定义
- **File**: `packages/core/src/config/llmProvider.ts`
- **Rationale**: 创建独立的模块定义LLM provider相关的类型和常量
- **内容**:
  - `LLMProviderConfig` 接口定义
  - `LLMProviderType` 枚举（当前包含 OPENROUTER）
  - `DEFAULT_OPENROUTER_BASE_URL` 常量
  - provider配置验证函数 `validateLLMProviderConfig`
  - 默认配置生成函数 `createDefaultProviderConfig`

#### 1.2 修改配置目录策略
- **File**: `packages/cli/src/config/settings.ts`
- **Rationale**: 实现 `.termichat` 目录优先级，保持向后兼容性
- **Changes**:
  - 修改 `SETTINGS_DIRECTORY_NAME` 常量为 `.termichat`
  - 创建 `LEGACY_SETTINGS_DIRECTORY_NAME` 常量为 `.gemini`
  - 修改 `USER_SETTINGS_DIR` 计算逻辑，优先检查 `.termichat`
  - 更新 `loadSettings` 函数实现配置迁移策略

#### 1.3 扩展Settings接口
- **File**: `packages/cli/src/config/settings.ts`  
- **Rationale**: 在现有配置结构中添加LLM provider支持
- **Changes**:
  - 在 `Settings` 接口添加 `llmProviders?: Record<string, LLMProviderConfig>`
  - 添加 `defaultLLMProvider?: string` 字段
  - 在 `computeMergedSettings` 中处理provider配置合并

#### 1.4 扩展AuthType枚举
- **File**: `packages/core/src/core/contentGenerator.ts`
- **Rationale**: 添加新的认证类型支持LLM provider
- **Changes**:
  - 在 `AuthType` 枚举添加 `USE_LLM_PROVIDER = 'llm-provider'`
  - 在 `createContentGeneratorConfig` 函数添加新类型处理逻辑
  - 在 `createContentGenerator` 函数添加provider生成器创建逻辑

### Phase 2: 命令系统实现

#### 2.1 创建Provider命令模块
- **File**: `packages/cli/src/ui/commands/providerCommand.ts`
- **Rationale**: 实现完整的provider管理命令集
- **Structure**:
  - 主命令: `providerCommand` (name: 'provider')
  - 子命令: `listSubCommand`, `addSubCommand`, `editSubCommand`, `removeSubCommand`, `setDefaultSubCommand`
  - 每个子命令包含 action 和 completion 函数
  - 错误处理和用户反馈逻辑

#### 2.2 集成命令加载器
- **File**: `packages/cli/src/services/BuiltinCommandLoader.ts`
- **Rationale**: 将新命令集成到现有命令系统
- **Changes**: 在 `loadCommands` 方法的commands数组中添加 `providerCommand`

### Phase 3: 用户界面组件

#### 3.1 创建输入字段组件
- **File**: `packages/cli/src/ui/components/shared/InputField.tsx`
- **Rationale**: 创建可复用的输入组件支持不同类型的字段输入
- **Features**:
  - 支持文本、密码、URL等类型
  - 内置验证逻辑
  - 错误状态显示
  - 可配置的placeholder和label

#### 3.2 创建Provider配置对话框
- **File**: `packages/cli/src/ui/components/ProviderDialog.tsx`
- **Rationale**: 提供友好的provider配置界面
- **Features**:
  - Provider类型选择（RadioButtonSelect）
  - API Key输入（InputField with password mask）
  - Base URL输入（InputField with URL validation）
  - 配置验证和保存逻辑
  - 错误处理和用户反馈

#### 3.3 创建Provider列表对话框
- **File**: `packages/cli/src/ui/components/ProviderListDialog.tsx`
- **Rationale**: 管理已配置的providers
- **Features**:
  - 显示所有已配置的providers
  - 支持编辑、删除、设为默认操作
  - 空状态提示和引导

#### 3.4 扩展AuthDialog
- **File**: `packages/cli/src/ui/components/AuthDialog.tsx`
- **Rationale**: 在认证选择中集成LLM provider选项
- **Changes**:
  - 在items数组添加 "Use LLM Provider" 选项
  - 条件显示（仅当有配置的provider时）
  - 更新initialAuthIndex逻辑

### Phase 4: 系统集成和验证

#### 4.1 扩展认证验证逻辑
- **File**: `packages/cli/src/config/auth.ts`
- **Rationale**: 为新的认证类型添加验证支持
- **Changes**:
  - 在 `validateAuthMethod` 函数添加 `USE_LLM_PROVIDER` case
  - 验证是否有配置的default provider
  - 验证provider配置的完整性

#### 4.2 创建Provider认证模块
- **File**: `packages/cli/src/config/llmProviderAuth.ts`
- **Rationale**: 独立的provider认证和验证逻辑
- **Functions**:
  - `validateProviderConfig`: 验证单个provider配置
  - `testProviderConnection`: 测试provider API连接
  - `getDefaultProvider`: 获取默认provider配置

#### 4.3 创建Provider管理Hook
- **File**: `packages/cli/src/ui/hooks/useProviderCommand.ts`
- **Rationale**: 管理provider相关的UI状态和操作
- **Features**:
  - Provider对话框状态管理
  - Provider CRUD操作
  - 错误处理和用户反馈

### Phase 5: 内容生成器集成

#### 5.1 创建LLM Provider内容生成器
- **File**: `packages/core/src/models/llmProviderGenerator.ts`
- **Rationale**: 实现基于配置的LLM provider API调用
- **Implementation**:
  - 实现 `ContentGenerator` 接口
  - 支持OpenRouter API格式
  - 处理API Key认证和Base URL配置
  - 错误处理和重试逻辑

#### 5.2 集成到内容生成系统
- **File**: `packages/core/src/core/contentGenerator.ts`
- **Rationale**: 完成与现有内容生成系统的集成
- **Changes**:
  - 在 `createContentGenerator` 中处理 `USE_LLM_PROVIDER` 类型
  - 加载默认provider配置
  - 创建并返回LLMProviderContentGenerator实例

## Implementation Checklist:

1. **[Phase 1.1]** ✅ 创建 `packages/core/src/config/llmProvider.ts` - 定义所有LLM provider相关类型和常量
2. **[Phase 1.2]** ✅ 修改 `packages/cli/src/config/settings.ts` - 实现 `.termichat` 目录策略
3. **[Phase 1.3]** ✅ 扩展 `packages/cli/src/config/settings.ts` Settings接口 - 添加provider配置字段
4. **[Phase 1.4]** ✅ 修改 `packages/core/src/core/contentGenerator.ts` - 扩展AuthType枚举
5. **[Phase 2.1]** 创建 `packages/cli/src/ui/commands/providerCommand.ts` - 实现provider命令
6. **[Phase 2.2]** 修改 `packages/cli/src/services/BuiltinCommandLoader.ts` - 集成provider命令
7. **[Phase 3.1]** 创建 `packages/cli/src/ui/components/shared/InputField.tsx` - 输入字段组件
8. **[Phase 3.2]** 创建 `packages/cli/src/ui/components/ProviderDialog.tsx` - Provider配置对话框
9. **[Phase 3.3]** 创建 `packages/cli/src/ui/components/ProviderListDialog.tsx` - Provider列表对话框
10. **[Phase 3.4]** 修改 `packages/cli/src/ui/components/AuthDialog.tsx` - 添加LLM provider选项
11. **[Phase 4.1]** 修改 `packages/cli/src/config/auth.ts` - 扩展认证验证
12. **[Phase 4.2]** 创建 `packages/cli/src/config/llmProviderAuth.ts` - Provider认证模块
13. **[Phase 4.3]** 创建 `packages/cli/src/ui/hooks/useProviderCommand.ts` - Provider管理Hook
14. **[Phase 5.1]** 创建 `packages/core/src/models/llmProviderGenerator.ts` - LLM Provider内容生成器
15. **[Phase 5.2]** 修改 `packages/core/src/core/contentGenerator.ts` - 集成provider内容生成器

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "[Paste Feature Fixed] API Key粘贴功能已修复完成"

# Task Progress (Appended by EXECUTE mode after each step completion)
*   2025-01-09
    *   Step: Phase 1.1 - 创建LLM Provider类型定义
    *   Modifications: 创建了 `packages/core/src/config/llmProvider.ts` 文件，定义了所有相关类型和验证函数
    *   Change Summary: 实现了LLMProviderType枚举、LLMProviderConfig接口、验证和默认配置创建函数
    *   Reason: 执行计划步骤Phase 1.1
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 1.2 - 修改配置目录策略
    *   Modifications: 修改了 `packages/cli/src/config/settings.ts`，实现了 `.termichat` 目录优先级和向后兼容性
    *   Change Summary: 添加了配置目录选择逻辑，优先使用 `.termichat`，向后兼容 `.gemini`
    *   Reason: 执行计划步骤Phase 1.2
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 1.3 - 扩展Settings接口
    *   Modifications: 扩展了Settings接口，添加了llmProviders和defaultLLMProvider字段，并修改了配置合并逻辑
    *   Change Summary: 在Settings接口中添加provider相关字段，更新了computeMergedSettings方法
    *   Reason: 执行计划步骤Phase 1.3
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 1.4 - 扩展AuthType枚举
    *   Modifications: 修改了 `packages/core/src/core/contentGenerator.ts`，添加了USE_LLM_PROVIDER认证类型和相关处理逻辑
    *   Change Summary: 扩展AuthType枚举，在createContentGeneratorConfig和createContentGenerator中添加处理逻辑
    *   Reason: 执行计划步骤Phase 1.4
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 2.1 - 创建Provider命令模块
    *   Modifications: 创建了 `packages/cli/src/ui/commands/providerCommand.ts`，实现了完整的provider管理命令集
    *   Change Summary: 实现了主命令和6个子命令(list, add, edit, remove, set-default, types)，包含命令逻辑、自动完成和错误处理
    *   Reason: 执行计划步骤Phase 2.1
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 2.2 - 集成命令加载器
    *   Modifications: 修改了 `packages/cli/src/services/BuiltinCommandLoader.ts`，将providerCommand集成到命令系统
    *   Change Summary: 在allDefinitions数组中添加了providerCommand，使其可以被命令系统加载和使用
    *   Reason: 执行计划步骤Phase 2.2
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 3.1 - 创建输入字段组件
    *   Modifications: 创建了 `packages/cli/src/ui/components/shared/InputField.tsx`，实现了可复用的输入组件
    *   Change Summary: 支持文本、密码、URL等类型，内置验证逻辑，错误状态显示，可配置的placeholder和label
    *   Reason: 执行计划步骤Phase 3.1
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 3.2 - 创建Provider配置对话框
    *   Modifications: 创建了 `packages/cli/src/ui/components/ProviderDialog.tsx`，实现了友好的provider配置界面
    *   Change Summary: 多步骤配置流程，支持Provider类型选择、API Key输入、Base URL输入，配置验证和保存逻辑
    *   Reason: 执行计划步骤Phase 3.2
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 3.3 - 创建Provider列表对话框
    *   Modifications: 创建了 `packages/cli/src/ui/components/ProviderListDialog.tsx`，实现了管理已配置的providers
    *   Change Summary: 显示所有已配置的providers，支持编辑、删除、设为默认操作，空状态提示和引导，删除确认对话框
    *   Reason: 执行计划步骤Phase 3.3
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 3.4 - 扩展AuthDialog
    *   Modifications: 修改了 `packages/cli/src/ui/components/AuthDialog.tsx`，在认证选择中集成LLM provider选项
    *   Change Summary: 在items数组添加 "Use LLM Provider" 选项，条件显示（仅当有配置的provider时），利用现有的initialAuthIndex逻辑
    *   Reason: 执行计划步骤Phase 3.4
    *   Blockers: None
    *   Status: Success 

*   2025-01-09
    *   Step: Provider Command对话框集成
    *   Modifications: 修改了多个文件以完成provider命令和对话框的集成：
     - `packages/cli/src/ui/commands/types.ts`: 扩展OpenDialogActionReturn支持provider对话框
     - `packages/cli/src/ui/commands/providerCommand.ts`: 修改addSubCommand和editSubCommand返回对话框打开指令
     - `packages/cli/src/ui/hooks/slashCommandProcessor.ts`: 添加provider对话框处理逻辑
     - `packages/cli/src/ui/App.tsx`: 集成ProviderDialog和ProviderListDialog到主应用界面
    *   Change Summary: 完成了从命令行到UI的完整集成，用户现在可以通过 `/provider add` 和 `/provider edit` 命令打开相应的对话框
    *   Reason: 修复用户反馈的addSubCommand对话框未对接问题
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: API Key粘贴功能修复
    *   Modifications: 修改了 `packages/cli/src/ui/components/shared/InputField.tsx`，增加粘贴功能支持
    *   Change Summary: 将useInput替换为useKeypress，添加对key.paste事件的处理，现在支持粘贴长文本（如API Key）
    *   Reason: 修复用户反馈的API Key输入困难问题，粘贴功能现在可用
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 4.1 - 扩展认证验证逻辑
    *   Modifications: 修改了 `packages/cli/src/config/auth.ts`，为新的认证类型添加验证支持
    *   Change Summary: 在 `validateAuthMethod` 函数添加 `USE_LLM_PROVIDER` case，验证是否有配置的default provider，验证provider配置的完整性
    *   Reason: 执行计划步骤Phase 4.1
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 4.2 - 创建Provider认证模块
    *   Modifications: 创建了 `packages/cli/src/config/llmProviderAuth.ts`，独立的provider认证和验证逻辑
    *   Change Summary: 实现了 `validateProviderConfig`、`testProviderConnection`、`getDefaultProvider` 函数
    *   Reason: 执行计划步骤Phase 4.2
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 4.3 - 创建Provider管理Hook
    *   Modifications: 创建了 `packages/cli/src/ui/hooks/useProviderCommand.ts`，管理provider相关的UI状态和操作
    *   Change Summary: Provider对话框状态管理，Provider CRUD操作，错误处理和用户反馈，自动设置第一个provider为默认
    *   Reason: 执行计划步骤Phase 4.3
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 5.1 - 创建LLM Provider内容生成器
    *   Modifications: 创建了 `packages/core/src/models/llmProviderGenerator.ts`，实现基于配置的LLM provider API调用
    *   Change Summary: 实现了 `ContentGenerator` 接口，支持OpenRouter API格式，处理API Key认证和Base URL配置，错误处理和重试逻辑
    *   Reason: 执行计划步骤Phase 5.1
    *   Blockers: None
    *   Status: Success

*   2025-01-09
    *   Step: Phase 5.2 - 集成到内容生成系统
    *   Modifications: 修改了 `packages/core/src/core/contentGenerator.ts`，完成与现有内容生成系统的集成
    *   Change Summary: 在 `createContentGenerator` 中处理 `USE_LLM_PROVIDER` 类型，加载默认provider配置，创建并返回LLMProviderContentGenerator实例
    *   Reason: 执行计划步骤Phase 5.2
    *   Blockers: None
    *   Status: Success 
